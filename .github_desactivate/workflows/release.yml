# Flujo de trabajo para crear releases
# VersiÃ³n simplificada para principiantes

name: Crear Release

# Eventos que activan el workflow
on:
  push:
    tags:
      - 'v*'  # Empuja tags que comienzan con 'v'

jobs:
  # Job de creaciÃ³n de release
  create-release:
    name: Crear Release
    runs-on: ubuntu-latest
    
    steps:
    # Paso 1: Checkout del cÃ³digo
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    # Paso 2: Extraer informaciÃ³n del tag
    - name: Extraer informaciÃ³n del release
      id: get_version
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ VersiÃ³n: $VERSION"
    
    # Paso 3: Generar changelog
    - name: Generar changelog
      run: |
        echo "# Release v${{ steps.get_version.outputs.version }}" > release-notes.md
        echo "" >> release-notes.md
        echo "## Fecha: $(date '+%Y-%m-%d')" >> release-notes.md
        echo "" >> release-notes.md
        echo "### Cambios:" >> release-notes.md
        echo "" >> release-notes.md
        
        # Obtener commits desde el Ãºltimo tag
        if git describe --tags --abbrev=0 HEAD~1 > /dev/null 2>&1; then
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1)
          echo "### Commits desde $PREVIOUS_TAG:" >> release-notes.md
          git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> release-notes.md
        else
          echo "### Todos los commits:" >> release-notes.md
          git log --pretty=format:"- %s (%h)" >> release-notes.md
        fi
        
        echo "" >> release-notes.md
        echo "---" >> release-notes.md
        echo "*Generado automÃ¡ticamente por GitHub Actions*" >> release-notes.md
    
    # Paso 4: Crear release en GitHub
    - name: Crear release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: Release v${{ steps.get_version.outputs.version }}
        body_path: release-notes.md
        draft: false
        prerelease: false
        files: |
          CHANGELOG.md
          README.md
          stack-facturador-smart/smart1.tar.gz
    
    # Paso 5: Notificar
    - name: Notificar creaciÃ³n de release
      run: |
        echo "ğŸ‰ Release creado exitosamente"
        echo "ğŸ·ï¸  Tag: ${{ steps.get_version.outputs.tag }}"
        echo "ğŸ“¦ VersiÃ³n: ${{ steps.get_version.outputs.version }}"
        echo "ğŸ“„ Notas: release-notes.md"
        echo "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag }}"