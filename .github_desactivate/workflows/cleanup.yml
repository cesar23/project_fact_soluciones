# Flujo de trabajo de limpieza
# Limpia im√°genes Docker y cach√© peri√≥dicamente

name: Limpieza Autom√°tica

# Eventos que activan la limpieza
on:
  schedule:
    # Ejecutar todos los domingos a las 4 AM UTC
    - cron: '0 4 * * 0'
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  # Job de limpieza
  cleanup:
    name: Limpieza de Docker y Cach√©
    runs-on: ubuntu-latest
    
    steps:
    # Paso 1: Limpieza en Staging
    - name: Limpieza en staging
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          echo "üßπ Iniciando limpieza en staging..."
          
          # Limpiar contenedores detenidos
          docker container prune -f
          
          # Limpiar im√°genes sin usar
          docker image prune -a -f
          
          # Limpiar redes sin usar
          docker network prune -f
          
          # Limpiar vol√∫menes sin usar
          docker volume prune -f
          
          # Limpiar build cache
          docker builder prune -a -f
          
          echo "‚úÖ Limpieza de staging completada"
          docker system df
    
    # Paso 2: Limpieza en Producci√≥n
    - name: Limpieza en producci√≥n
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          echo "üßπ Iniciando limpieza en producci√≥n..."
          
          # Limpiar contenedores detenidos
          docker container prune -f
          
          # Limpiar im√°genes sin usar
          docker image prune -a -f
          
          # Limpiar redes sin usar
          docker network prune -f
          
          # Limpiar vol√∫menes sin usar
          docker volume prune -f
          
          # Limpiar build cache
          docker builder prune -a -f
          
          echo "‚úÖ Limpieza de producci√≥n completada"
          docker system df
    
    # Paso 3: Notificar finalizaci√≥n
    - name: Notificar finalizaci√≥n
      run: |
        echo "üéâ Limpieza autom√°tica completada"
        echo "üìÖ Fecha: $(date)"
        echo "üßπ Espacio liberado en ambos servidores"