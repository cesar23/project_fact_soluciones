# Flujo de trabajo de escaneo de seguridad
# VersiÃ³n simplificada para principiantes

name: Escaneo de Seguridad

# Eventos que activan el pipeline
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Ejecutar todos los domingos a las 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  # Job de escaneo de seguridad
  security-scan:
    name: Escaneo de Seguridad
    runs-on: ubuntu-latest
    
    steps:
    # Paso 1: Checkout del cÃ³digo
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    # Paso 2: Escanear dependencias de Composer
    - name: Escanear dependencias PHP
      uses: php-actions/composer@v6
      with:
        command: install --no-dev --no-progress
    - name: Ejecutar seguridad check
      run: |
        # Instalar security-checker si no estÃ¡ disponible
        if ! command -v security-checker &> /dev/null; then
          wget https://github.com/fabpot/local-php-security-checker/releases/download/v1.0.0/local-php-security-checker_1.0.0_linux_amd64
          chmod +x local-php-security-checker_1.0.0_linux_amd64
          sudo mv local-php-security-checker_1.0.0_linux_amd64 /usr/local/bin/security-checker
        fi
        
        # Escanear vulnerabilidades
        cd stack-facturador-smart/smart1
        security-checker security:check composer.lock
    
    # Paso 3: Escanear imÃ¡genes Docker
    - name: Ejecutar Trivy security scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'rash07/php-fpm:7.4'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: 0  # No fallar el build por vulnerabilidades
    
    # Paso 4: Escanear cÃ³digo en busca de secretos
    - name: Escanear secretos en cÃ³digo
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
    
    # Paso 5: Escanear vulnerabilidades de GitHub
    - name: GitHub Security Scan
      uses: github/github-super-linter@v4
      env:
        VALIDATE_ALL_CODEBASE: false
        VALIDATE_PHP: true
        VALIDATE_BASH: true
        VALIDATE_YAML: true
        VALIDATE_JSON: true
        DEFAULT_BRANCH: main
    
    # Paso 6: Subir resultados de escaneo
    - name: Subir resultados de seguridad
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    
    # Paso 7: Generar reporte de seguridad
    - name: Generar reporte de seguridad
      if: always()
      run: |
        echo "# Reporte de Seguridad" > security-report.md
        echo "" >> security-report.md
        echo "## Fecha: $(date)" >> security-report.md
        echo "## Commit: ${{ github.sha }}" >> security-report.md
        echo "" >> security-report.md
        echo "### Resumen:" >> security-report.md
        echo "- âœ… Escaneo de dependencias PHP completado" >> security-report.md
        echo "- âœ… Escaneo de imÃ¡genes Docker completado" >> security-report.md
        echo "- âœ… Escaneo de secretos completado" >> security-report.md
        echo "- âœ… AnÃ¡lisis de cÃ³digo completado" >> security-report.md
        echo "" >> security-report.md
        echo "### PrÃ³ximos pasos:" >> security-report.md
        echo "1. Revisar los resultados en GitHub Security" >> security-report.md
        echo "2. Actualizar dependencias vulnerables" >> security-report.md
        echo "3. Aplicar parches de seguridad" >> security-report.md
        
        cat security-report.md
    
    # Paso 8: Notificar resultados
    - name: Notificar resultados
      if: always()
      run: |
        echo "ğŸ”’ Escaneo de seguridad completado"
        echo "ğŸ“Š Revisa los resultados en GitHub Security"
        echo "âš ï¸  Si hay vulnerabilidades, actualiza las dependencias"