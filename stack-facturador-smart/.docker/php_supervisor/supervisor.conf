; =============================================================================
; LARAVEL QUEUE WORKERS - SMART FACTURADOR
; =============================================================================
; Archivo: stack-facturador-smart/smart1/supervisor.conf
; Este archivo se monta en: /etc/supervisor/conf.d/supervisor.conf
; =============================================================================

[program:laravel-worker]
; Nombre único para cada proceso
process_name=%(program_name)s_%(process_num)02d

; Comando para ejecutar el worker
; - redis: nombre de la conexión (debe coincidir con config/queue.php)
; - --sleep=3: espera 3 segundos si no hay jobs
; - --tries=3: reintentar jobs fallidos hasta 3 veces
; - --timeout=300: timeout de 5 minutos por job
; - --max-time=3600: reiniciar worker después de 1 hora (previene memory leaks)
command=php /var/www/html/artisan queue:work redis --sleep=3 --tries=3 --timeout=300 --max-time=3600

; Iniciar automáticamente cuando supervisor arranca
autostart=true

; Reiniciar automáticamente si el proceso falla
autorestart=true

; Matar todo el grupo de procesos al detener
stopasgroup=true
killasgroup=true

; Usuario que ejecuta el proceso
user=root

; Número de procesos a ejecutar en paralelo
; Ajustar según la carga esperada y recursos disponibles
numprocs=8

; Redirigir stderr a stdout
redirect_stderr=true

; Archivo de log individual por proceso
; %(process_num)02d genera: 00, 01, 02, etc.
stdout_logfile=/var/www/html/storage/logs/supervisor-%(process_num)02d.log

; Tamaño máximo del archivo de log antes de rotar
stdout_logfile_maxbytes=10MB

; Número de archivos de backup a mantener
stdout_logfile_backups=5

; Tiempo de espera antes de forzar la terminación (1 hora)
; Permite que los jobs en ejecución terminen antes de matar el proceso
stopwaitsecs=3600

; Tiempo mínimo que el proceso debe estar corriendo para considerarlo exitoso
startsecs=1

; Número de reintentos si el proceso falla al iniciar
startretries=3

; Prioridad de inicio (menor número = mayor prioridad)
priority=999

; Variables de entorno adicionales (opcional)
;environment=LARAVEL_ENV="production"
